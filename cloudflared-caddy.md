# Cloudflared Caddy to launch website without a Public IP Address

### Requirements:
1. Docker
2. Caddy -  web server
3. Cloudflared docker container: to create the tunnel

### Setup
- Two Docker containers : 1 hosting the website and another hosting cloudflared.
- One Docker network: So cloudflare tunnel can host the website.

## 1. Setting up the Website:

#### before that WHY CADDY?
##### Pros:
  - Extremely easy to set up with automatic HTTPS via Let's Encrypt.
  - The configuration is done through a simple file.
  - Written in Go, making it quite performant and low on resource usage.
##### Cons:
  - Less mature and has a smaller community than Nginx or Apache.
  - The simplicity of configuration might limit complex setups.

### The Setup:
1. Caddyfile:
```
hostname {
  root * /usr/share/caddy
  file_server
}
```
2. Dockerfile
```
# Start from the Alpine base image
FROM alpine:latest

# Install Caddy
RUN apk add --no-cache caddy

# Copy the Caddyfile and site contents into the container
COPY Caddyfile /etc/caddy/Caddyfile
COPY /path/to/your/site /usr/share/caddy

# Expose the HTTP port
EXPOSE 80

# Set the working directory
WORKDIR /usr/share/caddy

# Start Caddy
CMD ["caddy", "file-server", "--root", "/usr/share/caddy"]
```

3. Running and verifying the container:
```
# Build your Docker image
docker build -t my-caddy-site .

# Run your Docker container
docker run -d -p 80:80 --name my-caddy-site my-caddy-site
```

## 2. Setting up Cloudflare
### Step 1: Set Up Domain with Cloudflare
- Register Your Domain: First, ensure you have registered the domain.
- Add Your Domain to Cloudflare: Sign up for a Cloudflare account and add your domain to it. Cloudflare will provide you with nameservers to set at your domain registrar.
- Update Nameservers: Update the nameservers for doamin at your domain registrar to point to Cloudflare.
e.g. some cloudflare dns look like: raon.cloudflare.com

### Step 2: Set Up Cloudflare Tunnel
- Install Cloudflared: On your server (not in a container), install cloudflared, the software needed to create a Cloudflare Tunnel. You can find installation instructions on Cloudflare's official website.
  ```
  sudo apt install cloudflared
  ```
- Authenticate Cloudflared: Run `cloudflared tunnel login` to authenticate and link cloudflared to your Cloudflare account. 
This will provide a link, where you authenticate with the connection

- Create a Tunnel: Run `cloudflared tunnel create my-tunnel` to create a new tunnel. Replace my-tunnel with a name of your choice.
_NOTE_: Make sure to make a copy of the location where the credential file was created and Also the id of the created tunnel.

- Access Cloudflare DNS Settings through browser
  1. Log in to Cloudflare: Go to the Cloudflare dashboard and log in with your credentials.
  2. Select Your Domain: Choose the domain for which you want to create the CNAME record (vkcyber.com in your case).
  3. Go to the DNS Section: Navigate to the DNS settings page for your domain.

- Create a CNAME Record
  
  1. Add a New Record: Click on the "Add Record" button.
  
  2. Record Type: Select "CNAME" from the dropdown menu. Name: Enter the subdomain or root domain you wish to use.
  ```
  For example:
  For a subdomain like www, enter www in the Name field.
  For the root domain (personal-domain-name), you can simply put @ in the Name field.
  ```
  3. Target: Enter your tunnel's hostname. It will be in the format of <TUNNEL_ID>.cfargotunnel.com.
  4. Proxy status: Make sure it is set to "Proxied" (orange cloud icon). This ensures that traffic goes through Cloudflare's network, enabling features like Cloudflare Tunnel to work correctly.
  5. Save the Record: Click on the "Save" button to add the record.

- Configure the Tunnel: Create a configuration file for your tunnel, typically named config.yml. Here's an example configuration:
```
tunnel: [TUNNEL-ID]
credentials-file: /path/to/credentials.json

ingress:
  - hostname: vkcyber.com
    service: http://my-caddy-site:80
  - service: http_status:404
```
_NOTE_: Make sure the container name `my-caddy-site` in the `service` section matches the container name of the docker container for Caddy based Website.

### Step 3: Starting and maintaining the tunnel's container

```
sudo docker run -d --name my-cloudflared-tunnel \
  -v /path/to/config.yml:/etc/cloudflared/config.yml \
  -v /path/to/credential/.json:/etc/cloudflared/credentials.json \
  cloudflare/cloudflared:latest tunnel run
```

- In above command, make sure to correctly map the `config.yml` path.
- the path to credential file, should be same in both the places: above command & config.yml

#### By this time, the cloudflare tunnel should be up and running, with the website running in parallel. If we try to access the website, now it wont work as cloudflare tunnel is not in same network.

## 3. Create a Docker Network between these two containers

- Create a Docker Network: First, create a Docker network that both containers can use to communicate with each other.
```
sudo docker network create my-network
```
- Connect Containers to the Network: Connect your existing containers to this network.
```
sudo docker network connect my-network my-site
sudo docker network connect my-network cloudflare-tunnel
```

- Restart the cloudflare-tunnel container:
```
sudo docker restart cloudflare-tunnel
```

Voila, the Website should now be directly accessible.
